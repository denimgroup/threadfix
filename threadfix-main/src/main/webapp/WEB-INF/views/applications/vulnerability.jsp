<%@ include file="/common/taglibs.jsp"%>

<head>
    <title>Vulnerability Details</title>
    <cbs:cachebustscript src="/scripts/vulnerability-detail-page-controller.js"/>
    <cbs:cachebustscript src="/scripts/document-form-controller.js"/>
    <cbs:cachebustscript src="/scripts/upload-scan-controller.js"/>
    <cbs:cachebustscript src="/scripts/modal-controller-with-config.js"/>
    <cbs:cachebustscript src="/scripts/defect-submission-modal-controller.js"/>
    <cbs:cachebustscript src="/scripts/add-to-existing-defect-controller.js"/>
    <cbs:cachebustscript src="/scripts/grc-control-submission-modal-controller.js"/>
    <cbs:cachebustscript src="/scripts/modal-controller-with-config.js"/>
    <cbs:cachebustscript src="/scripts/vuln-operations-controller.js"/>
</head>

<body id="apps" class="vulnDetails" ng-controller="VulnerabilityDetailPageController" ng-init="isShowInfo = false; toggleBtnText = 'Toggle More Info'">
<%@ include file="/WEB-INF/views/angular-init.jspf"%>
<%@ include file="/WEB-INF/views/applications/forms/vulnCommentForm.jsp"%>
<%@ include file="/WEB-INF/views/applications/forms/vulnTaggingForm.jsp"%>
<%@ include file="/WEB-INF/views/applications/forms/uploadDocForm.jsp" %>
<%@ include file="/WEB-INF/views/defects/submitDefectForm.jsp" %>
<%@ include file="/WEB-INF/views/applications/modals/submitGRCControl.jsp" %>
<%@ include file="/WEB-INF/views/defects/addToExistingDefectForm.jsp" %>

<spring:url value="/organizations/{orgId}" var="teamUrl">
    <spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
</spring:url>
<spring:url value="/organizations/{orgId}/applications/{applicationId}" var="applicationUrl">
    <spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
    <spring:param name="applicationId" value="${ vulnerability.application.id }" />
</spring:url>
<spring:url value="/organizations/{orgId}/applications/{applicationId}/vulnerabilities/{nextVulnId}/batch/{batchIds}/{nextRank}" var="nextVulnBatchUrl">
    <spring:param name="orgId" value="${ nextVuln.application.organization.id }" />
    <spring:param name="applicationId" value="${ nextVuln.application.id }" />
    <spring:param name="nextVulnId" value="${ nextVuln.id }" />
    <spring:param name="batchIds" value="${ batchIds }" />
    <spring:param name="nextRank" value="${ currentRank + 1 }" />
    <spring:param name="numBatchVulns" value="${ numBatchVulns }" />
</spring:url>
<spring:url value="/organizations/{orgId}/applications/{applicationId}/vulnerabilities/{previousVulnId}/batch/{batchIds}/{nextRank}" var="previousVulnBatchUrl">
    <spring:param name="orgId" value="${ previousVuln.application.organization.id }" />
    <spring:param name="applicationId" value="${ previousVuln.application.id }" />
    <spring:param name="previousVulnId" value="${ previousVuln.id }" />
    <spring:param name="batchIds" value="${ batchIds }" />
    <spring:param name="nextRank" value="${ currentRank - 1 }" />
    <spring:param name="numBatchVulns" value="${ numBatchVulns }" />
</spring:url>

<ul class="breadcrumb">
    <li><a href="<spring:url value="/teams"/>">Applications Index</a> <span class="divider">/</span></li>
    <li><a ng-non-bindable href="${ fn:escapeXml(teamUrl) }">Team: <c:out value="${ vulnerability.application.organization.name }"/></a> <span class="divider">/</span></li>
    <li><a ng-non-bindable href="${ fn:escapeXml(applicationUrl) }">Application: <c:out value="${ vulnerability.application.name }"/></a> <span class="divider">/</span></li>
    <li class="active">Vulnerability {{ vulnId }}</li>
</ul>

<c:if test="${not empty batchIds}">
    <ul class="breadcrumb" style="margin-top:-25px">
        <li>Batch reviewing: ${ currentRank } / ${ numBatchVulns }</li>
        <li style="margin-left: 10px">
            <c:if test="${not empty previousVuln}"><a href="${ fn:escapeXml(previousVulnBatchUrl) }">Previous</a></c:if>
            <c:if test="${empty previousVuln}"><span style="color:dimgray">Previous</span></c:if>
        </li>
        <li style="margin: 0 3px 0 3px">-</li>
        <li>
            <c:if test="${not empty nextVuln}"><a href="${ fn:escapeXml(nextVulnBatchUrl) }">Next</a></c:if>
            <c:if test="${empty nextVuln}"><span style="color:dimgray">Next</span></c:if>
        </li>
     </ul>
</c:if>

<h2>Vulnerability Details
	<span style="font-size:10pt;">
		<div class="btn-group" ng-controller="VulnOperationsController">
            <button id="actionItems" ng-show="showActionButton" class="btn dropdown-toggle" data-toggle="dropdown" type="button">
                Action <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <c:if test="${ canModifyVulnerabilities }">
                    <li ng-show="vulnerability.active && !vulnerability.hidden"><a id="closeVulnerabilityLink" class="pointer" ng-click="closeVuln()">Close Vulnerability</a></li>
                    <li ng-show="!vulnerability.active && !vulnerability.hidden"><a id="openVulnerabilityLink" class="pointer" ng-click="openVuln()">Open Vulnerability</a></li>
                    <li ng-show="!vulnerability.isFalsePositive"><a id="markFalsePositiveLink" class="pointer" ng-click="markFalsePositive()">Mark as False Positive</a></li>
                    <li ng-show="vulnerability.isFalsePositive"><a id="unmarkFalsePositiveLink" class="pointer" ng-click="unmarkFalsePositive()">Unmark False Positive</a></li>
                </c:if>
                <li ng-show="vulnerability.defect"><a id="viewDefectLink" class="pointer" ng-click="viewDefect()">View Defect</a></li>
                <c:if test="${ canSubmitDefects}">
                    <li ng-show="vulnerability.app.defectTracker && !vulnerability.defect"><a class="pointer" ng-click="showSubmitDefectModal()">Create Defect</a></li>
                    <li ng-show="vulnerability.app.defectTracker && !vulnerability.defect"><a class="pointer" ng-click="showMergeDefectModal()">Add to Existing Defect</a></li>
                </c:if>
                <c:if test="${ canModifyVulnerabilities }">
                    <li><a id="taggingLink" class="pointer" ng-click="tagVuln(vulnTags)">Add Tagging</a></li>
                </c:if>
            </ul>
        </div>
    </span>
    <span id="tag{{ tag.name }}" ng-repeat="tag in vulnerability.tags" class="badge pointer" ng-class="{'badge-vulnerability-tag': true}" ng-click="goToTag(tag)">{{ tag.name }}</span>
    <span id="version{{ version.name}}" ng-repeat="version in vulnerability.versions" class="badge" ng-class="{'badge-vulnerability-version': true}">{{ version.name }}</span>
</h2>

<%@ include file="/WEB-INF/views/successMessage.jspf" %>
<%@ include file="/WEB-INF/views/errorMessage.jspf"%>
<%@ include file="/WEB-INF/views/scans/finding/editManualFindingForm.jsp" %>
<%@ include file="/WEB-INF/views/scans/finding/editDescriptionFindingForm.jsp" %>

<h3 style="padding-top:0;">
    <span class="label badge {{ badgeClassMap[vulnerability.genericSeverity.intValue] }}">
        {{ vulnerability.genericSeverity.displayName }}
    </span>
    <span tooltip="CWE-{{ vulnerability.genericVulnerability.displayId }}">{{ vulnerability.vulnerabilityName }}</span>
    -- <a id="cweLink" href="http://cwe.mitre.org/data/definitions/{{ vulnerability.genericVulnerability.displayId }}.html" target="_blank">CWE Entry</a>
</h3>

<c:set var="editVisible" value="false"/>

<c:forEach var="finding" items="${ vulnerability.findings }">
    <c:if test="${ finding.scan.applicationChannel.channelType.name == 'Manual'}">
        <c:set var="editVisible" value="true"/>
    </c:if>
</c:forEach>

<div ng-if="findings">
    <table class="table sortable table-hover" id="2">
        <thead>
            <tr>
                <th style="width:5px; padding:0"></th>
                <th style="width:10px"></th>
                <th>Scanner Name</th>
                <th>Finding Name</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat-start="finding in findings" class="pointer finding-row" ng-click="toggle(finding)">
                <td class="{{ badgeClassMap[finding.channelSeverity.severityMap.genericSeverity.intValue] }}" style="padding:0"></td>
                <td><span class="caret-right" ng-class="{ expanded: finding.expanded }"></span></td>
                <td id="scannerName{{ $index }}">{{ finding.scannerName }}</td>
                <td id="vulnName{{ $index }}" style="word-wrap: break-word;">{{ finding.channelVulnerability.name }}</td>
                <td style="word-wrap: break-word;">{{ finding.surfaceLocation.humanLocation }}</td>
            </tr>
            <tr ng-repeat-end>
                <td style="padding:0; border-top:inherit"></td>
                <td class="grey-background" style="padding:inherit; border-top:inherit" colspan="5">
                    <div style="padding:5px 10px 25px" ng-show="finding.expanded">
                        <table class="dataTable finding-table">
                            <tr ng-if="finding.channelSeverity.name">
                                <td class="bold">Scanner Severity</td>
                                <td>{{ finding.channelSeverity.name }}</td>
                            </tr>
                            <tr ng-if="finding.longDescription">
                                <td class="bold">Description</td>
                                <td>{{ finding.longDescription }}</td>
                            </tr>
                            <tr ng-if="finding.surfaceLocation.path">
                                <td class="bold">Path</td>
                                <td>{{ finding.surfaceLocation.path }}</td>
                            </tr>
                            <tr ng-if="finding.surfaceLocation.parameter">
                                <td class="bold">Parameter</td>
                                <td>{{ finding.surfaceLocation.parameter }}</td>
                            </tr>
                            <tr ng-if="finding.attackString">
                                <td class="bold">Attack String</td>
                                <td><pre>{{ finding.attackString }}</pre></td>
                            </tr>
                            <tr ng-if="finding.scannerDetail">
                                <td class="bold">Scanner Detail</td>
                                <td style="word-wrap: break-word;"><pre>{{ finding.scannerDetail }}</pre></td>
                            </tr>
                            <tr ng-if="finding.scannerRecommendation">
                                <td class="bold">Scanner Recommendation</td>
                                <td><pre>{{ finding.scannerRecommendation }}</pre></td>
                            </tr>
                            <tr ng-if="finding.attackRequest">
                                <td class="bold">Attack Request</td>
                                <td><pre>{{ finding.attackRequest }}</pre></td>
                            </tr>
                            <tr ng-if="finding.attackResponse">
                                <td class="bold">Attack Response</td>
                                <td><pre>{{ finding.attackResponse }}</pre></td>
                            </tr>
                        </table>
                        <div style="padding:8px;">
                            <div ng-if="finding.dataFlowElements && finding.dataFlowElements.length > 0" style="font-weight:bold; margin-top:10px;">Data Flow</div>
                            <div ng-repeat="dataFlowElement in finding.dataFlowElements">
                                {{ dataFlowElement.sourceFileName }} line {{ dataFlowElement.lineNumber }}
                                <pre>{{ dataFlowElement.lineText }}</pre>
                            </div>
                            <c:if test="${ canModifyVulnerabilities }">
                                <div ng-if = "finding.scannerName === 'Manual'">
                                    <a id="editLink" ng-click="openEditFindingModal(finding)" class="pointer">Edit</a>
                                </div>
                                <div ng-if = "finding.scannerName !== 'Manual'">
                                    <a id="editDescriptionLink" ng-click="openEditDescriptionModal(finding, $index)" class="pointer">Edit Description</a>
                                </div>
                            </c:if>
                            <div>
                                <a id="viewLink" ng-href="{{ finding.pageUrl }}" class="pointer">View Finding page</a>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<h4>Status</h4>
<div id="vulnHistory">
    <div class="grey-background">
        <table class="dataTable table">
            <thead>
                <tr>
                    <th colspan="3">
                        <span ng-if="vulnerability.active" class="badge">open</span>
                        <span ng-if="!vulnerability.active" class="badge badge-success">closed</span>
                        <span ng-if="vulnerability.isFalsePositive" class="badge badge-info">false positive</span>
                        <span ng-if="vulnerability.hidden" class="badge badge-inverse">hidden</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr ng-if="vulnerability.humanTimes.openTime">
                    <td class=bold>Open date<td>
                    <td>{{ vulnerability.humanTimes.openTime }}<td>
                </tr>
                <tr ng-if="vulnerability.humanTimes.wafRuleGeneratedTime">
                    <td class=bold>WAF rule generated<td>
                    <td>{{ vulnerability.humanTimes.wafRuleGeneratedTime }}<td>
                </tr>
                <tr ng-if="vulnerability.humanTimes.closeTime">
                    <td class=bold>Found closed by scanner<td>
                    <td>{{ vulnerability.humanTimes.closeTime }}<td>
                </tr>
             </tbody>
        </table>
    </div>
    <div ng-if="vulnerability.defect" style="margin-left:30px;" class="grey-background">
        <table class="dataTable table">
            <thead>
                <tr>
                    <th colspan="3">
                    <a ng-href="{{ vulnerability.defect.defectURL }}" target="_blank" class="badge">
                        Issue {{ vulnerability.defect.nativeId }} ({{ vulnerability.defect.status }})
                    </a>
                    - {{ vulnerability.app.defectTracker.name }}
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr ng-if="vulnerability.humanTimes.defectSubmittedTime">
                    <td class=bold>Submitted date<td>
                    <td>{{ vulnerability.humanTimes.defectSubmittedTime }}<td>
                </tr>
                <tr ng-if="vulnerability.humanTimes.defectClosedTime">
                    <td class=bold>Marked as closed by tracker<td>
                    <td>{{ vulnerability.humanTimes.defectClosedTime }}<td>
                </tr>
             </tbody>
        </table>
    </div>
</div>

<div ng-show="links">
    <h4>External Links</h4>
    <span ng-repeat="link in links">
        {{ link.scannerName }}: <a href="{{ link.urlReference }}" target="_blank">{{ link.urlReference }}</a> <br/>
    </span>
</div>

<h4>Comments</h4>
<%@ include file="/WEB-INF/views/applications/vulnComments.jsp" %>
<c:if test="${ canSubmitComments }">
    <a id="addCommentButton" class="btn" ng-click="openCommentModal()">Add Comment</a>
</c:if>

<br/>

<div ng-controller="DocumentFormController">
    <h4>Files</h4>
    <%@ include file="/WEB-INF/views/applications/docsTable.jsp" %>
    <c:if test="${ canModifyVulnerabilities }">
        <a id="uploadDocVulnModalLink" class="btn" ng-click="showUploadForm()">Add File</a>
    </c:if>
</div>

<c:if test="${isEnterprise}">
    <jsp:include page="/app/organizations/${ vulnerability.application.organization.id }/applications/${ vulnerability.application.id }/vulnerabilities/${ vulnerability.id }/history"/>
</c:if>

</body>