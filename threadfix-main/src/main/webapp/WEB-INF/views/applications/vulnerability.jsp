<%@ include file="/common/taglibs.jsp"%>

<head>
	<title>Vulnerability Details</title>
    <script type="text/javascript" src="<%=request.getContextPath()%>/scripts/vulnerability-detail-page-controller.js"></script>
</head>

<body id="apps" ng-controller="VulnerabilityDetailPageController">
    <%@ include file="/WEB-INF/views/angular-init.jspf"%>
    <%@ include file="/WEB-INF/views/applications/forms/vulnCommentForm.jsp"%>
    <%@ include file="/WEB-INF/views/applications/forms/uploadDocVulnForm.jsp" %>

	<spring:url value="/organizations/{orgId}" var="teamUrl">
		<spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
	</spring:url>
	<spring:url value="/organizations/{orgId}/applications/{applicationId}" var="applicationUrl">
		<spring:param name="orgId" value="${ vulnerability.application.organization.id }" />
		<spring:param name="applicationId" value="${ vulnerability.application.id }" />
	</spring:url>
	
	<ul class="breadcrumb">
	    <li><a href="<spring:url value="/"/>">Applications Index</a> <span class="divider">/</span></li>
	    <li><a href="${ fn:escapeXml(teamUrl) }">Team: <c:out value="${ vulnerability.application.organization.name }"/></a> <span class="divider">/</span></li>
	    <li><a href="${ fn:escapeXml(applicationUrl) }">Application: <c:out value="${ vulnerability.application.name }"/></a> <span class="divider">/</span></li>
	    <li class="active">Vulnerability <c:out value="${ vulnerability.id }"/></li>
    </ul>
	
	<h2>Vulnerability Details
	<span style="font-size:10pt;">
		<a href="#statisticsDiv" data-toggle="collapse" class="btn  header-button">Toggle More Info</a>
	</span>
	</h2>
	
	<div id="helpText">
		This page lists information about a specific Vulnerability.
	</div>
	
	<div id="statisticsDiv" class="container-fluid collapse">
		<div class="row-fluid">
			<c:if test="${ canModifyVulnerabilities }">
				<c:if test="${ vulnerability.active and not vulnerability.hidden }">
					<spring:url
						value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/close"
						var="closeUrl">
						<spring:param name="applicationId"
							value="${ vulnerability.application.id }" />
						<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
					</spring:url>
					<a class="btn" id="closeVulnerabilityLink" href="${ fn:escapeXml(closeUrl) }">Close Vulnerability</a>
				</c:if>
				<c:if test="${ not vulnerability.active and not vulnerability.hidden }">
					<spring:url
						value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/open"
						var="closeUrl">
						<spring:param name="applicationId"
							value="${ vulnerability.application.id }" />
						<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
					</spring:url>
					<a class="btn" id="openVulnerabilityLink" href="${ fn:escapeXml(closeUrl) }">Open Vulnerability</a>
				</c:if>
				
				<c:if test="${ not vulnerability.isFalsePositive }">
					<spring:url
						value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/markFalsePositive"
						var="closeUrl">
						<spring:param name="applicationId"
							value="${ vulnerability.application.id }" />
						<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
					</spring:url>
					<a class="btn" id="markFalsePositiveLink" href="${ fn:escapeXml(closeUrl) }">Mark as False Positive</a>
				</c:if>
				<c:if test="${ vulnerability.isFalsePositive }">
					<spring:url
						value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/markNotFalsePositive"
						var="closeUrl">
						<spring:param name="applicationId"
							value="${ vulnerability.application.id }" />
						<spring:param name="vulnerabilityId" value="${ vulnerability.id }" />
					</spring:url>
					<a class="btn" id="unmarkFalsePositiveLink" href="${ fn:escapeXml(closeUrl) }">Unmark False Positive</a>
				</c:if>
				<c:if test="${ not empty vulnerability.defect }">
					<spring:url value="../../../applications/{applicationId}/vulnerabilities/{vulnerabilityId}/defect" var="defectUrl">
						<spring:param name="applicationId" value="${ vulnerability.application.id }"/>
						<spring:param name="vulnerabilityId" value="${ vulnerability.id }"/>
					</spring:url>
					<a class="btn" id="viewDefectLink" href="${ fn:escapeXml(defectUrl) }">View Defect</a>
				</c:if>
			</c:if>
		</div>
		<div class="row-fluid">
			<div class="span6">
				<h4>Attack Surface</h4>
			
				<table class="dataTable">
					<tr>
						<td class="bold">Host</td>
						<td id="host" class="inputValue"><c:out value="${ surfaceLocation.host }" /></td>
					</tr>
					<tr>
						<td class="bold">Path</td>
						<td id="path" class="inputValue"><c:out value="${ surfaceLocation.path }" /></td>
					</tr>
					<tr>
						<td class="bold">Protocol</td>
						<td id="protocol" class="inputValue"><c:out
								value="${ surfaceLocation.protocol }" /></td>
					</tr>
					<tr>
						<td class="bold">Port</td>
						<td id="port" class="inputValue"><c:if
								test="${ surfaceLocation.port != -1 }">
								<c:out value="${ surfaceLocation.port }" />
							</c:if></td>
					</tr>
					<tr>
						<td class="bold">Query</td>
						<td id="query" class="inputValue"><c:out
								value="${ surfaceLocation.query }" /></td>
					</tr>
					<tr>
						<td class="bold">Parameter</td>
						<td id="parameter" class="inputValue"><c:out
								value="${ surfaceLocation.parameter }" /></td>
					</tr>
				</table>
			</div>
			<div class="span6">
				<c:if test="${not empty timeArray}">
					<h4>Status History</h4>
					<table class="table table-striped">
						<thead>
							<tr>
								<th class="first">Event</th>
								<th class="middle">Date</th>
								<th class="last"># Days</th>
							</tr>
						</thead>
						<tbody>
							<tr class="bodyRow">
								<td>Opened</td>
								<td id="vulnOpenTime"><fmt:formatDate value="${ vulnerability.openTime.time }"
										type="both" dateStyle="short" timeStyle="medium" /></td>
								<td><c:out value="${timeArray[0]}" /></td>
							</tr>
							<tr class="bodyRow">
								<td>WAF rule generated</td>
								<td id="vulnWafRuleTime"><fmt:formatDate
										value="${ vulnerability.wafRuleGeneratedTime.time }" type="both"
										dateStyle="short" timeStyle="medium" /></td>
								<td><c:out value="${timeArray[1]}" /></td>
							</tr>
							<tr class="bodyRow">
								<td>Submitted to tracker</td>
								<td id="vulnDefectSubmittedTime"><fmt:formatDate
										value="${ vulnerability.defectSubmittedTime.time }" type="both"
										dateStyle="short" timeStyle="medium" /></td>
								<td><c:out value="${timeArray[2]}" /></td>
							</tr>
							<tr class="bodyRow">
								<td>Marked as closed by tracker</td>
								<td id="vulnClosedInTrackerTime"><fmt:formatDate
										value="${ vulnerability.defectClosedTime.time }" type="both"
										dateStyle="short" timeStyle="medium" /></td>
								<td><c:out value="${timeArray[3]}" /></td>
							</tr>
							<tr class="bodyRow">
								<td><c:choose>
										<c:when test="${vulnerability.foundByScanner}">Found closed by scanner</c:when>
										<c:otherwise>Marked closed</c:otherwise>
									</c:choose></td>
								<td id="vulnCloseTime"><fmt:formatDate value="${ vulnerability.closeTime.time }"
										type="both" dateStyle="short" timeStyle="medium" /></td>
								<td><c:out value="${timeArray[4]}" /></td>
							</tr>
						</tbody>
					</table>
				</c:if>
			</div>
		</div>
	</div>

    <%@ include file="/WEB-INF/views/successMessage.jspf" %>
    <%@ include file="/WEB-INF/views/errorMessage.jsp"%>

	<h4>Basic Information</h4>
	<c:if test="${ vulnerability.genericSeverity.name == 'Critical' }">
		<c:set var="color" value="error" />
	</c:if>
	<c:if test="${ vulnerability.genericSeverity.name == 'High' }">
	      <c:set var="color" value="warning" />
	</c:if>
	<c:if test="${ vulnerability.genericSeverity.name == 'Medium' }">
	      <c:set var="color" value="success" />
	</c:if>
	<c:if test="${ vulnerability.genericSeverity.name == 'Low' }">
	      <c:set var="color" value="info" />
	</c:if>
	<c:if test="${ vulnerability.genericSeverity.name == 'Info' }">
	      <c:set var="color" value="info" />
	</c:if>
	<table class="table">
		<thead>
			<tr>
				<th>
					Type
				</th>
				<th>
					Severity
				</th>
				<c:if test="${ empty vulnerability.originalFinding.dependency }">
					<th>
						Path
					</th>
					<th>
						Parameter
					</th>
				</c:if>
				<c:if test="${ not empty vulnerability.originalFinding.dependency }">
					<th>
						CVE ID
					</th>				
				</c:if>
			</tr>
		</thead>
		<tr class="bodyRow <c:out value="${ color }"/>">
			<td id="type${ vulnStatus.count }">
			    <c:out value="${ vulnerability.genericVulnerability.name }"/>
			    <spring:url value="http://cwe.mitre.org/data/definitions/{vulnId}.html" var="cweUrl">
					<spring:param name="vulnId" value="${ vulnerability.genericVulnerability.id }" />
				</spring:url>
				(<a id="cweLink" href="${ fn:escapeXml(cweUrl) }" target="_blank">CWE Entry</a>)
				
			</td>
			<td id="severity${ vulnStatus.count }"><c:out value="${ vulnerability.genericSeverity.name }"/></td>
			<c:if test="${ empty vulnerability.originalFinding.dependency }">
				<td id="path${ vulnStatus.count }"><c:out value="${ vulnerability.surfaceLocation.path }"/></td>
				<td id="parameter${ vulnStatus.count }"><c:out value="${ vulnerability.surfaceLocation.parameter }"/></td>
			</c:if>
			<c:if test="${ not empty vulnerability.originalFinding.dependency }">
				<td id="cve${ vulnStatus.count }">
					<c:out value="${ vulnerability.originalFinding.dependency.cve } "/>
					(<a target="_blank" id="linkCve${ vulnStatus.count }" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=${ vulnerability.originalFinding.dependency.cve }">View</a>)
				</td>
			</c:if>
		</tr>
	</table>
	
	<c:set var="editVisible" value="false"/>
	
	<c:forEach var="finding" items="${ vulnerability.findings }">
	    <c:if test="${ finding.scan.applicationChannel.channelType.name == 'Manual'}">
			<c:set var="editVisible" value="true"/>
		</c:if>
	</c:forEach>

	<c:if test="${not empty vulnerability.findings}">
		<h4>Findings</h4>
		<table class="table table-striped sortable" id="2" style="table-layout:fixed;">
			<thead>
				<tr>
					<th class="first">Scanner Name</th>
					<th>Severity</th>
					<th>Vulnerability Type</th>
					<c:if test="${ empty vulnerability.originalFinding.dependency }">
						<th>Path</th>
						<th>
							Calculated URL Path
						</th>
						<th>
							Calculated Source Path
						</th>
						<th>Parameter</th>
						<th>Native ID</th>
					</c:if>
					<c:if test="${ not empty vulnerability.originalFinding.dependency }">
						<th>
							CVE ID
						</th>				
					</c:if>
					<c:if test="${ editVisible }">				
						<th>Edit</th>
					</c:if>
					<th style="width:80px"></th>
				</tr>
			</thead>
			<tbody>
				<c:forEach var="finding" items="${ vulnerability.findings }" varStatus="status">
					<c:set var="color" value="info" />
					<c:if test="${ finding.channelSeverity.numericValue == 5 }">
					      <c:set var="color" value="error" />
					</c:if>
					<c:if test="${ finding.channelSeverity.numericValue == 4 }">
					      <c:set var="color" value="warning" />
					</c:if>
					<c:if test="${ finding.channelSeverity.numericValue == 3 }">
					      <c:set var="color" value="success" />
					</c:if>
					<c:if test="${ finding.channelSeverity.numericValue == 2 }">
					      <c:set var="color" value="info" />
					</c:if>
					<c:if test="${ finding.channelSeverity.numericValue == 1 }">
					      <c:set var="color" value="info" />
					</c:if>
					
					<tr class="bodyRow ${ color }">
						<td id="scannerName${ status.count }"><c:out
								value="${ finding.scan.applicationChannel.channelType.name }" />
						</td>
						<td id="severityName${ status.count }"><c:out value="${ finding.channelSeverity.name }" /></td>
						<td id="vulnName${ status.count }" style="word-wrap: break-word;">
							<c:out value="${ finding.channelVulnerability.name }" />
						</td>
						<c:if test="${ empty vulnerability.originalFinding.dependency }">
							<td id="path${ status.count }" style="max-width:100px;word-wrap: break-word;">
								<c:out value="${ finding.surfaceLocation.path }" />
							</td>
							<td id="pathRoot${ vulnStatus.count }" style="max-width:100px;word-wrap: break-word;">
								<c:out value="${ finding.calculatedUrlPath }"/>
							</td>
							<td id="sourceRoot${ vulnStatus.count }" style="max-width:175px;word-wrap: break-word;">
								<c:out value="${ finding.calculatedFilePath }"/>
							</td>
							<td id="parameter${ status.count }"><c:out value="${ finding.surfaceLocation.parameter }" /></td>
							<td id="nativeId${ status.count }" style="max-width:125px;word-wrap: break-word;">
								<c:if test="${ not empty finding.displayId }"><c:out value="${ finding.displayId }" /></c:if>
								<c:if test="${ empty finding.displayId }"><c:out value="${ finding.nativeId }" /></c:if>
							</td>
						</c:if>
						<c:if test="${ not empty vulnerability.originalFinding.dependency }">
							<td id="cve${ status.count }">
								<c:out value="${ finding.dependency.cve }"/>
								(<a target="_blank" id="linkCve${ status.count }" href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=${ finding.dependency.cve }">View</a>)
							</td>	
						</c:if>					
						<c:if test="${ editVisible }">
							<td>
								<c:if test="${ finding.scan.applicationChannel.channelType.name == 'Manual'}">
                                    <a id="editLink" href="#editManualFindingModal${ finding.id }" data-toggle="modal">Edit</a>
                                    <%@ include file="/WEB-INF/views/scans/finding/editManualFindingModal.jsp" %>
								</c:if>
							</td>
						</c:if>
						<td>
							<spring:url value="../scans/{scanId}/findings/{findingId}" var="findingUrl">
								<spring:param name="scanId" value="${ finding.scan.id }" />
								<spring:param name="findingId" value="${ finding.id }" />
							</spring:url> 
							<a href="${ fn:escapeXml(findingUrl) }"> 
								View Finding
							</a>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</c:if>

	<c:if test="${not empty staticFindingList}">
		<h4>Data Flow Variants</h4>
		<c:forEach var="finding" items="${staticFindingList}" varStatus="findingStatus">
			<c:if test="${ not empty finding.dataFlowElements }">
				<a href="javascript:toggleid('<c:out value="${ finding.id }"/>');">Toggle
					finding <c:out value="${ finding.id }" /> data flow (Elements: <c:out
						value="${ fn:length(finding.dataFlowElements) }" />)
				</a>
				<br />

				<div id='<c:out value="${ finding.id }"/>' style="display: none;">
					<h4>
						Finding
						<c:out value="${ finding.id }" />
						Data Flow
					</h4>
					<c:forEach var="dataFlowElement" varStatus="dataFlowElementStatus"
						items="${finding.dataFlowElements}">
						<table class="dataTable">
							<tr>
								<td>File Name</td>
								<td id="finding${ findingStatus.count }SourceFileName${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.sourceFileName }" /></td>
							</tr>
							<tr>
								<td>Line number</td>
								<td id="finding${ findingStatus.count }LineNumber${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.lineNumber }" /></td>
							</tr>
							<tr>
								<td>Line text</td>
								<td id="finding${ findingStatus.count }LineText${ dataFlowElementStatus.count }" 
									class="inputValue"><c:out value="${ dataFlowElement.lineText }" /></td>
							</tr>
							<tr>
								<td></td>
							</tr>
						</table>
					</c:forEach>
				</div>
			</c:if>
		</c:forEach>
	</c:if>

	<c:if
		test="${ not empty singleStaticFinding and not empty singleStaticFinding.dataFlowElements }">
		<h4>Data Flow</h4>
		<c:forEach var="dataFlowElement" varStatus="status"
			items="${singleStaticFinding.dataFlowElements}">
			<table class="dataTable">
				<tr>
					<td>File Name</td>
					<td id="sourceFileName${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.sourceFileName }" /></td>
				</tr>
				<tr>
					<td>Line number</td>
					<td id="lineNumber${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.lineNumber }" /></td>
				</tr>
				<tr>
					<td>Line text</td>
					<td id="lineText${ status.count }" class="inputValue"><c:out
							value="${ dataFlowElement.lineText }" /></td>
				</tr>
				<tr>
					<td></td>
				</tr>
			</table>
		</c:forEach>
	</c:if>

	<br/>

    <h4>Comments</h4>
    <%@ include file="/WEB-INF/views/applications/vulnComments.jsp" %>
    <c:if test="${ canModifyVulnerabilities }">
        <a class="btn" ng-click="openCommentModal()">Add Comment</a>
    </c:if>

    <br/>

    <div ng-controller="DocumentFormController">
        <h4>Files</h4>
        <%@ include file="/WEB-INF/views/applications/docsTable.jsp" %>
        <c:if test="${ canModifyVulnerabilities }">
            <a id="uploadDocVulnModalLink" class="btn" ng-click="openDocModal()">Add File</a>
        </c:if>
    </div>
</body>

