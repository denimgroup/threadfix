var myAppModule = angular.module('threadfix')

myAppModule.controller('VulnerabilityDetailPageController', function ($scope, $window, $http, $rootScope, tfEncoder, $modal, $log, vulnSearchParameterService) {

    $scope.vulnId  = $window.location.pathname.match(/([0-9]+)$/)[0];
    $scope.teamId = $window.location.pathname.match(/([0-9]+)/)[0];
    $scope.appId = $window.location.pathname.match(/([0-9]+)/g)[1];
    $scope.currentUrl = "/organizations/" + $scope.teamId + "/applications/" + $scope.appId + "/vulnerabilities/" + $scope.vulnId;
    $scope.canUpdateVulnComment = true;


    $scope.$on('rootScopeInitialized', function() {

        $scope.refresh();
    });

    $scope.showInfo = function() {
        if ($scope.isShowInfo) {
            $scope.isShowInfo = false;
            $scope.toggleBtnText = 'Toggle More Info';
        } else {
            $scope.isShowInfo = true;
            $scope.toggleBtnText = 'Toggle Hide Info';
        }
    };

    $scope.openCommentModal = function() {

        var modalInstance = $modal.open({
            templateUrl: 'vulnCommentForm.html',
            controller: 'ModalControllerWithConfig',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.currentUrl + "/addComment");
                },
                object: function () {
                    return {};
                },
                config: function() {
                    return {tags: $scope.tags};
                },
                buttonText: function() {
                    return "Add Comment";
                }
            }
        });

        modalInstance.result.then(function (comments) {
            $scope.successMessage = "Successfully added new comment";
            $scope.vulnerability.vulnerabilityComments = comments;
            vulnSearchParameterService.updateVulnCommentTags($scope.tags, $scope.vulnerability);
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    };

    $scope.openEditFindingModal = function(finding) {

        var modalInstance = $modal.open({
            templateUrl: 'editManualFindingForm.html',
            windowClass: 'wide',
            controller: 'ModalControllerWithConfig',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.currentUrl + "/manual/" + finding.id + "/edit");
                },
                object: function() {
                    if (!finding.dataFlowElements || finding.dataFlowElements.length === 0) {
                        finding.dataFlowElements = [{}];
                    };
                    finding.id = null;
                    var findingCopy = angular.copy(finding);
                    $scope.config.manualSeverities.forEach(function(severity) {
                        if (severity.name === finding.channelSeverity.name) {
                            findingCopy.channelSeverity = severity;
                        }
                    });
                    return findingCopy;
                },
                config: function() {
                    return $scope.config;
                },
                buttonText: function() {
                    return "Submit Finding";
                }
            }
        });

        $scope.currentModal = modalInstance;

        modalInstance.result.then(function (result) {
            $scope.vulnId = result.id;
            $scope.currentUrl = "/organizations/" + $scope.teamId + "/applications/" + $scope.appId + "/vulnerabilities/" + result.id;
            $scope.refresh();
            $scope.successMessage = "Finding has been edited.";
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });


    };

    $scope.goToFinding = function(finding) {
        $window.location.href = tfEncoder.encode("/organizations/" + $scope.teamId + "/applications/" + $scope.appId + "/scans/" + finding.scanId + "/findings/" + finding.id);
    };

    $scope.toggleFinding = function(finding) {
        $scope['isShowFlow' + finding.id] = $scope['isShowFlow' + finding.id] ? false : true;
    };

    $scope.refresh = function() {
        $http.get(tfEncoder.encode($scope.currentUrl + '/table')).
            success(function(data, status, headers, config) {

                if (data.success) {
                    $scope.vulnerability = data.object.vulnerability;
                    $scope.documents = data.object.vulnerability.documents;
                    $scope.findings = data.object.vulnerability.findings;
                    $scope.surfaceLocation = data.object.surfaceLocation;
                    $scope.singleStaticFinding = data.object.singleStaticFinding;
                    $scope.staticFindingList = data.object.staticFindingList;
                    $scope.tags = data.object.tags;
                    vulnSearchParameterService.updateVulnCommentTags($scope.tags, $scope.vulnerability);

                    $scope.config = data.object;
                    if (!$scope.config.recentFileList) {
                        $scope.config.recentFileList = [];
                    }
                    if (!$scope.config.recentPathList) {
                        $scope.config.recentPathList = [];
                    }
                } else {
                    $scope.errorMessage = "Failure. Message was : " + data.message;
                }
            }).
            error(function(data, status, headers, config) {
                $scope.errorMessage = "Failed to retrieve waf list. HTTP status was " + status;
            });
    };
    
    $scope.updateVulnComment = function(vulnerability, comment){
        $http.post(tfEncoder.encode($scope.currentUrl + '/vulnComments/' + comment.id + "/update"), comment).
            success(function(data, status, headers, config) {

                if (data.success) {
                    comment.commentChanged = false;
                } else {
                    $scope.errorMessage = "Failure. Message was : " + data.message;
                }
            }).
            error(function(data, status, headers, config) {
                $scope.errorMessage = "Failed to retrieve waf list. HTTP status was " + status;
            });
    }

    $scope.changeComment = function(vulnerability, comment){
        comment.commentChanged = true;
    }

});
