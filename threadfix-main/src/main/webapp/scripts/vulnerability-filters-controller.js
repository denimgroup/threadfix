var threadfixModule = angular.module('threadfix');

threadfixModule.controller("VulnerabilityFiltersController", function($modal, $scope, $http, $log) {

    var nameCompare = function(a,b) {
        return a.sourceGenericVulnerability.name.localeCompare(b.sourceGenericVulnerability.name);
    };

    var toStrings = function(severityFilter) {
        for (var key in severityFilter) {
            if (severityFilter.hasOwnProperty(key) && key.toString().substring(0,4) === "show") { // to make IntelliJ happy
                if (severityFilter[key] === true) {
                    severityFilter[key] = "true";
                }

                if (severityFilter[key] === false) {
                    severityFilter[key] = "false";
                }
            }
        }

        return severityFilter;
    }

    var toBooleans = function(severityFilter) {
        for (var key in severityFilter) {
            if (severityFilter.hasOwnProperty(key) && key.toString().substring(0,4) === "show") { // to make IntelliJ happy
                if (severityFilter[key] === "true") {
                    severityFilter[key] = true;
                }

                if (severityFilter[key] === "false") {
                    severityFilter[key] = false;
                }
            }
        }

        return severityFilter;
    }

    $scope.$watch('csrfToken', function(){
        $http.get(tfEncoder.encodeRelative('filters/map')).
            success(function(data, status, headers, config) {

                if (data.success) {

                    $scope.type = data.object.type;

                    $scope.genericSeverities = data.object.genericSeverities;
                    $scope.genericVulnerabilities = data.object.genericVulnerabilities;

                    $scope.vulnerabilityFilter = data.object.vulnerabilityFilter;
                    $scope.globalSeverityFilter = data.object.globalSeverityFilter;
                    $scope.globalVulnerabilityFilterList = data.object.globalVulnerabilityFilterList;

                    if ($scope.type !== 'Global') {
                        $scope.teamVulnerabilityFilters = data.object.teamVulnerabilityFilters;
                        $scope.teamSeverityFilter = data.object.teamSeverityFilter;
                    }

                    if ($scope.type === 'Application') {
                        $scope.applicationVulnerabilityFilters = data.object.applicationVulnerabilityFilters;
                        $scope.applicationSeverityFilter = data.object.applicationSeverityFilter;
                    }

                    $scope.setTab(data.object.type);
                } else {
                    $scope.errorMessage = "Failure. Message was : " + data.message;
                }

                $scope.initialized = true;
            }).
            error(function(data, status, headers, config) {
                $scope.initialized = true;
                $scope.errorMessage = "Failed to retrieve map. HTTP status was " + status;
            });
    });

    $scope.setTab = function(tab) {
        $scope.tab = tab;

        $scope.severitySuccessMessage = undefined;
        $scope.severityErrorMessage = undefined;

        if (tab === 'Global') {
            $scope.vulnFiltersTitle = 'Global Vulnerability Filters';
            $scope.severityFiltersTitle = 'Global Severity Filters';
            $scope.severityFilter = toStrings($scope.globalSeverityFilter);
            $scope.vulnerabilityFilterList = $scope.globalVulnerabilityFilterList;
            $scope.submitRoot = "/configuration/filters/";

        } else if (tab === 'Applications' || tab === 'Application') {
            $scope.vulnFiltersTitle = 'Application Vulnerability Filters';
            $scope.severityFiltersTitle = 'Application Severity Filters';
            $scope.severityFilter = toStrings($scope.applicationSeverityFilter);
            $scope.vulnerabilityFilterList = $scope.applicationVulnerabilityFilters;
            $scope.submitRoot = "filters/";
        } else {
            $scope.severityFiltersTitle = 'Team Severity Filters';
            $scope.vulnFiltersTitle = 'Team Vulnerability Filters';
            $scope.severityFilter = toStrings($scope.teamSeverityFilter);
            $scope.vulnerabilityFilterList = $scope.teamVulnerabilityFilters;
            if ($scope.type === 'Team') {
                $scope.submitRoot = "filters/";
            } else {
                var regex = /(\/organizations\/[0-9]+\/)/
                $scope.submitRoot = regex.exec(window.location.pathname)[0] + "filters/"
            }
        }

        if ($scope.vulnerabilityFilterList && $scope.vulnerabilityFilterList.length > 0) {
            $scope.vulnerabilityFilterList.sort(nameCompare);
            $scope.currentVulnFilters = $scope.vulnerabilityFilterList;
        } else {
            $scope.currentVulnFilters = undefined;
        }

    }

    $scope.showNewFilterModal = function() {
        var modalInstance = $modal.open({
            windowClass: 'filter-modal',
            templateUrl: 'vulnerabilityFilterForm.html',
            controller: 'ModalControllerWithConfig',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.submitRoot + "new");
                },
                object: function () {
                    return {
                        targetGenericSeverity: {
                            id: 5
                        }
                    }
                },
                config: function() {
                    return {
                        showDelete: false,
                        title: 'New Filter',
                        genericVulnerabilities: $scope.genericVulnerabilities,
                        genericSeverities: $scope.genericSeverities
                    }
                },
                buttonText: function() {
                    return "Create Filter";
                }
            }
        });

        modalInstance.result.then(function (newApplication) {

            if (!$scope.currentVulnFilters) {
                $scope.currentVulnFilters = [];
            }

            $scope.currentVulnFilters.push(newApplication);

            $scope.currentVulnFilters.sort(nameCompare);

            $scope.successMessage = "Successfully added application " + newApplication.name;

        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    }

    $scope.editFilter = function(filter) {
        var modalInstance = $modal.open({
            windowClass: 'filter-modal',
            templateUrl: 'vulnerabilityFilterForm.html',
            controller: 'ModalControllerWithConfig',
            resolve: {
                url: function() {
                    return tfEncoder.encode($scope.submitRoot + filter.id + "/edit");
                },
                object: function () {
                    return filter;
                },
                config: function() {
                    return {
                        showDelete: true,
                        title: 'Edit Filter',
                        genericVulnerabilities: $scope.genericVulnerabilities,
                        genericSeverities: $scope.genericSeverities
                    }
                },
                buttonText: function() {
                    return "Save Changes";
                },
                deleteUrl: function() {
                    return tfEncoder.encode($scope.submitRoot + filter.id + "/delete");
                }
            }
        });

        modalInstance.result.then(function (newFilter) {

            if (newFilter) {
                filter.targetGenericSeverity = newFilter.targetGenericSeverity;
                filter.sourceGenericVulnerability = newFilter.sourceGenericVulnerability;
                $scope.successMessage = "Successfully edited filter " + newFilter.id;
            } else {
                var index = $scope.currentVulnFilters.indexOf(filter);

                if (index > -1) {
                    $scope.currentVulnFilters.splice(index, 1);
                }

                if ($scope.currentVulnFilters.length === 0) {
                    $scope.currentVulnFilters = undefined;
                }
            }
        }, function () {
            $log.info('Modal dismissed at: ' + new Date());
        });
    }

    $scope.submitSeverityFilterForm = function() {
        $scope.submittingSeverityFilter = true;

        $scope.severitySuccessMessage = undefined;
        $scope.severityErrorMessage = undefined;

        $http.post(tfEncoder.encode($scope.submitRoot + 'severityFilter/set'), toBooleans($scope.severityFilter)).
            success(function(data, status, headers, config) {

                if (data.success) {
                    $scope.severitySuccessMessage = "Successfully saved filter settings.";
                } else {
                    $scope.severityErrorMessage = "Failure. Message was : " + data.message;
                }

                $scope.submittingSeverityFilter = false;
            }).
            error(function(data, status, headers, config) {
                $scope.submittingSeverityFilter = false;
                $scope.severityErrorMessage = "Failed to retrieve map. HTTP status was " + status;
            });

        toStrings($scope.severityFilter);
    }

});